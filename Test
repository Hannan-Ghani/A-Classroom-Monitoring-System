import org.apache.spark.sql.SparkSession
import org.apache.spark.sql.functions._
import com.amazonaws.services.glue.util.GlueArgParser

object TransactionProcessing {

  def main(sysArgs: Array[String]): Unit = {
    // Initialize Spark Session
    val spark = SparkSession.builder.appName("TransactionProcessing").getOrCreate()

    // Retrieve job parameters from Glue job configuration
    val args = GlueArgParser.getResolvedOptions(sysArgs, Seq(
      "SOURCE_PATH",           // S3 path for source data
      "TARGET_PATH",           // S3 path for target data
      "OUTPUT_PATH"            // S3 path for saving difference results
    ).toArray)

    // Extract parameter values
    val sourcePath = args("SOURCE_PATH")             // Path to source data
    val targetPath = args("TARGET_PATH")             // Path to target data
    val outputPath = args("OUTPUT_PATH")             // Path to save differences

    // Load source and target DataFrames from S3
    val source = spark.read.parquet(sourcePath)
    val target = spark.read.parquet(targetPath)

    // Dynamically compare all columns by ensuring both DataFrames have the same columns
    val commonColumns = source.columns.toSet.intersect(target.columns.toSet).toSeq

    val sourceSelected = source.select(commonColumns.map(col): _*)
    val targetSelected = target.select(commonColumns.map(col): _*)

    // Find rows in source but not in target (differences from source perspective)
    val sourceDifferences = sourceSelected.exceptAll(targetSelected)

    // Find rows in target but not in source (differences from target perspective)
    val targetDifferences = targetSelected.exceptAll(sourceSelected)

    // Combine both sets of differences
    val allDifferences = sourceDifferences.union(targetDifferences).distinct()

    // Save the differences to the specified S3 path as a Parquet file
    allDifferences.write.mode("overwrite").parquet(s"$outputPath/differences")

    // Log a message based on the differences
    if (allDifferences.isEmpty) {
      println(s"No differences found. The output is an empty table.")
    } else {
      println(s"Differences have been found and saved to: $outputPath/differences")
    }
  }
}